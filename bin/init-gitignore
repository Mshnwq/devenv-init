#!/usr/bin/env bash
set -e

template="$1"

if [ -z "$template" ]; then
  echo "Usage: $0 <template>"
  exit 1
fi

# Ensure gibo is installed unless template is helm
if [ "$template" != "helm" ] && ! command -v gibo >/dev/null 2>&1; then
  echo "gibo is not installed. Please install it first."
  exit 1
fi

if [ "$template" = "helm" ]; then
  # Append Helm ignores
  cat >> .gitignore <<'EOF'

# Helm-specific ignores
# Ignore Helm chart build artifacts
**/*.tgz
**/tmpcharts/
**/cache/
**/repository/
**/index.yaml
**/.lock
**/Chart.lock
**/output/

# Ignore Kubernetes manifests generated by Helm
**/manifest.yaml
**/manifest.json

# Ignore Helm dependencies
**/charts/*/charts/
**/requirements.lock

# Ignore IDE and system files
**/.idea/
**/.keys/
**/.vscode/
**/.DS_Store
**/*.swp
**/.bolt/
!.envrc

# Devenv
.devenv*
devenv.local.nix

# direnv
.direnv

# pre-commit
.pre-commit-config.yaml

# temporary
scripts/release-analysis/
scripts/configs/
# scripts/diff.sh
**/__snapshot__/
**/.debug/
**/values-test.yaml

# Generated from init-devenv template: helm
EOF

  echo "✅ .gitignore updated with Helm-specific ignores"

  cat >> .helmignore <<'EOF'
# Patterns to ignore when building packages.
# This supports shell glob matching, relative path matching, and
# negation (prefixed with !). Only one pattern per line.
.DS_Store
# Common VCS dirs
.git/
.github/
.gitignore
.gitlab-ci/
.gitlab-ci.yml
# Common backup files
*.swp
*.bak
*.tmp
*~
# Various IDEs
.project
*.tmproj
.idea/
.vscode/
.devenv/
.direnv/
.envrc
flake.nix
flake.lock
devenv.nix
devenv.yaml
devenv.lock

# Temp
*.gotmpl
/*.tgz
output/
ci/
argo/
unittests/
__snapshot__/
Makefile

# Generated from init-devenv template: helm
EOF

  echo "✅ .helmignore updated with Helm-specific ignores"
else
  # Normal gibo template + custom ignores
  echo "# Generated from gibo template: $template" >> .gitignore
  gibo dump "$template" >> .gitignore

  # Append custom env ignores
  cat >> .gitignore <<'EOF'

.vscode/
.idea/
*.DS_Store
.bolt/

!.envrc

# Devenv
.devenv*
devenv.local.nix

# direnv
.direnv

# pre-commit
.pre-commit-config.yaml
EOF

  echo "✅ .gitignore updated with $template + custom ignores"
fi
