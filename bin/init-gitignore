#!/usr/bin/env bash
set -e

template="$1"

if [ -z "$template" ]; then
  echo "Usage: $0 <template>"
  exit 1
fi

# Ensure gibo is installed unless template is helm
if [ "$template" != "helm" ] && ! command -v gibo >/dev/null 2>&1; then
  echo "gibo is not installed. Please install it first."
  exit 1
fi

if [ "$template" = "helm" ]; then
  # Append Helm ignores
  cat >> .gitignore <<'EOF'

# Helm-specific ignores
# Ignore Helm chart build artifacts
**/*.tgz
**/tmpcharts/
**/cache/
**/repository/
**/index.yaml
**/.lock
**/output/

# Ignore Kubernetes manifests generated by Helm
**/manifest.yaml
**/manifest.json

# Ignore Helm dependencies
**/charts/*/charts/
**/requirements.lock

# Ignore IDE and system files
**/.idea/
**/.keys/
**/.vscode/
**/.DS_Store
**/*.swp
**/.bolt/
!.envrc

# Devenv
.devenv*
devenv.local.nix

# direnv
.direnv

# pre-commit
.pre-commit-config.yaml

# temporary
scripts/release-analysis/
scripts/configs/
# scripts/diff.sh
**/__snapshot__/
**/.debug/
**/values-test.yaml

# Generated from gibo template: helm
EOF

  echo "✅ .gitignore updated with Helm-specific ignores"
else
  # Normal gibo template + custom ignores
  echo "# Generated from gibo template: $template" >> .gitignore
  gibo dump "$template" >> .gitignore

  # Append custom env ignores
  cat >> .gitignore <<'EOF'

.vscode/
.idea/
*.DS_Store
.bolt/

!.envrc

# Devenv
.devenv*
devenv.local.nix

# direnv
.direnv

# pre-commit
.pre-commit-config.yaml
EOF

  echo "✅ .gitignore updated with $template + custom ignores"
fi
