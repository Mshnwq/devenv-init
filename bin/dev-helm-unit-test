#!/usr/bin/env bash
set -e

# Parse args
PRINT_TEST=0
TARGET=""
CHART=""

while [[ $# -gt 0 ]]; do
  case "$1" in
  --print)
    PRINT_TEST=1
    shift
    ;;
  --chart)
    CHART="$2"
    shift 2
    ;;
  *)
    TARGET="$1"
    shift
    ;;
  esac
done

# Change directory if --chart is provided
if [ -n "$CHART" ]; then
  if [ ! -d "charts/$CHART" ]; then
    echo "Error: chart 'charts/$CHART' not found"
    exit 1
  fi
  cd "charts/$CHART"
fi

TEST_DIR=./unittests
SNAPSHOT_DIR=$TEST_DIR/__snapshot__

# Default: run all tests
tests=$(find "$TEST_DIR" -name "*.yaml" | xargs -n1 basename | sed 's/\.yaml$//')

run_test() {
  local testname="$1"

  find "$SNAPSHOT_DIR" -name "$testname.yaml.snap" -delete
  helm unittest --color -f "$TEST_DIR/$testname.yaml" .

  if [ "$PRINT_TEST" = "1" ]; then
    bat --theme=base16 --show-all \
      --paging=never "$SNAPSHOT_DIR/$testname.yaml.snap"
  fi
}

if [ "$TARGET" = "all" ]; then
  for t in $tests; do
    run_test "$t"
  done
else
  if [ ! -f "$TEST_DIR/$TARGET.yaml" ]; then
    echo "Error: test '$TARGET' does not exist in $TEST_DIR"
    exit 1
  fi
  run_test "$TARGET"
fi
